<!DOCTYPE html>
<html lang="en">

    <head>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="">

        <title>Hey baby, what's your sign going to be?</title>



        <!-- Bootstrap core CSS -->
        <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">



        <!-- Custom styles for this template -->
        <!-- SETH: to get everything in one file, I commented this out and moved the content of full.css into the <style> tags below. -->
<!-- <link href="css/full.css" rel="stylesheet"> -->



<style>

body {
    /*SETH: I didn't want the background to show, so I commented it out.*/
    /*background: url("./back.png") no-repeat center center fixed;*/
    -webkit-background-size: cover;
    -moz-background-size: cover;
    background-size: cover;
    -o-background-size: cover;
}


body {
    background: #eee;
}

svg {
    display: block;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.filler {
    background: #20B7AF;
    position: absolute;
    bottom: 50%;
    top: 0;
    left: 0;
    right: 0;
}


.page-content {
    height: 100%;
    padding-top: 150px;
}


/* Logo w animation*/


.title-bar {
    font-size: 32pt;
}
.appear-stuck {
    animation: 5s fadeIn;
    animation-fill-mode: forwards;
    visibility: hidden;
    opacity: 0;
}

  @keyframes fadeIn {
      0% {
          visibility: hidden;
          opacity: 0;
      }
      100% {
          visibility: visible;
          opacity: 1;
      }
  }



  .astrological-input {
      font-size: 20pt;
          text-align: center;
      margin-left: 50px;
  }
  .astrological-input-form {
  }

  .astrological-output > .illustration {
      padding-top: 10px;
  }

  .svg-obj-planetary {
  }

  .svg-obj-surrogate {
  }

  .tippy-tooltip.hbwys-theme {
      width: 70%;
  }
    .form-part,
    .form-part > input {
        text-align: center;
    }
    .form-part > label {
        /*display: inline;*/
        display: block;
    }
    .form-part > input ,
    .form-part > select {
        width:250px;
        border-radius: 10px;
        border: 0;
    }
    .form-part > select {
        border:0;
        background-color: white;
        padding: 5px;
    }
    .form-part > input.btnSubmit {
        background-color: #4558de;
        color: white;
        box-shadow: 0 6px 15px 0 rgba(0,0,0,10);
    }
    .form-list-signs > label.disabled {
        cursor: not-allowed; /*change curser*/
        pointer-events: none; /*makes it so other radio options don't get deselected when this one is clicked*/
    }

    /*map*/
    .gllpMap.gllpMap {
        min-width: 200px;
        width: 100%;
        min-height: 200px;
        height: 100%;
        -webkit-filter: grayscale(85%); /* Safari 6.0 - 9.0 */
        filter: grayscale(85%);
    }
</style>



    </head>

    <body>

        <div class="modal fade" id="basicModal" tabindex="-1" role="dialog" aria-labelledby="basicModal" aria-hidden="true"  data-dismiss="modal">
            <div class="modal-dialog" data-dismiss="modal">
                <div class="modal-content">
                    <!--
                        <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        </div>
                    -->
                    <div class="modal-body explainer">
                        <h3>What is this?</h3>
                        <p>A common interpretation of astrology is that is depends on the gravity of the planets at the moment of birth.  Isaac Newton taught us when the gravity of a large planet far away equals a smaller object up close.  For example, Jupiter's pull on you right now equals a truck a few meters away.
                        </p>
                        <p>When you're giving birth, if you line stuff up around you to cancel out one planet and simulate another, you can give your baby any sign you'd like. 	We did all the math for you, so have fun.
                        </p>
                    </div>
                    <!--
                        <div class="modal-footer">
                        <button type="button" class="btn btn-default">Close</button>
                        </div>
                    -->
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" onHover="makeAppear()">
                <a class="navbar-brand title-bar" href="#">Hey <big>ðŸ‘¶</big>, what's your sign? <span class="appear-stuck"> What do you want it to be?</span></a>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#basicModal">Huh?</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="#">Home
                                <span class="sr-only">(current)</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Services</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Contact</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>


        <!-- Page Content -->

        <!-- SETH: These few lines below, and their closing tags throughout the document, will make it easier to make our site mobile friendly -->
        <div class="container-fluid page-content">
            <div class="row">
                <div class="col-md-5">

                    <!-- Input part -->
                    <!-- SETH: Forms are the basis of the Internet.  The code below defines a minimal form that the site will take input from to edit the image-->
                    <div class="astrological-input">
                        <form id="astro-main-form" class="astrological-input-form" onsubmit="
                    event.preventDefault();
                    fetchSwissAstroSun(this);
                    this.querySelector('.form-part2').classList.remove('invisible');
                    this.querySelector('.form-part2').classList.add('visible');
                    //return false prevents form submission
                    return false;
                                ">
            <div class="row">
                <div class="col form-part1">
                        <h2>
                            Tell us about your little one!
                        </h2>
                            <p class=form-part><label for="date">Birth date:</label><input id="date" name="date" type="date"></p>
                            <p class=form-part><label for="time">Birth time:</label><input id="time" name="time" type="time"><i class="fas fa-info-circle tooltipped" title="military time"></i></p>
                            <p class=form-part>
                            <fieldset class="gllpLatlonPicker" id="custom_id">
                                <label for="locationCoordinates">Birth location (lat, lon)
                                    <div id="map" class="gllpMap"></div>
                                    <input id="locationCoordinates" class="gllpCoordinates" name="locationCoordinates", value="38.54, -121.54">
                                    <input type="hidden" id="locationLat" class="gllpLatitude" name="locationLat", value="38.54">
                                    <input type="hidden" id="locationLon" class="gllpLongitude" name="locationLon" value="-121.74">
                                </label> 

                                <input type="hidden" class="gllpZoom" value="1"/>
                            </fieldset>
                            </p>
                            <p class=form-part><input name="btnSubmit" type="submit" class="btnSubmit btn tooltipped" value="Submit" title="hodwy"/></p>
                </div>
                <div class="col form-part2 invisible">
                        <h2>
                            What sign do want?
                        </h2>
                        <p class=form-part>
                        <div id="desiredsign" class="form-list-signs btn-group-toggle btn-group-vertical mr-2" data-toggle="buttons" role="group" aria-label="Signs group" onclick="
                                this.closest('#astro-main-form').btnSubmit.click();
                                ">
                            <label class="btn btn-secondary active" onclick="toggleActive(this);"><input type="radio" name="options" class="radio-sign" value="null">No Sign</label>
                            <label class="btn btn-secondary" onclick="toggleActive(this);"><input type="radio" name="options" class="radio-sign" value="1">Aries</label>
                            <label class="btn btn-secondary" onclick="toggleActive(this);"><input type="radio" name="options" class="radio-sign" value="2">Taurus</label>
                            <label class="btn btn-secondary" onclick="toggleActive(this);"><input type="radio" name="options" class="radio-sign" value="3">Gemini</label>
                            <label class="btn btn-secondary" onclick="toggleActive(this);"><input type="radio" name="options" class="radio-sign" value="4">Cancer</label>
                            <label class="btn btn-secondary" onclick="toggleActive(this);"><input type="radio" name="options" class="radio-sign" value="5">Leo</label>
                            <label class="btn btn-secondary" onclick="toggleActive(this);"><input type="radio" name="options" class="radio-sign" value="6">Virgo</label>
                            <label class="btn btn-secondary" onclick="toggleActive(this);"><input type="radio" name="options" class="radio-sign" value="7">Libra</label>
                            <label class="btn btn-secondary" onclick="toggleActive(this);"><input type="radio" name="options" class="radio-sign" value="8">Scorpio</label>
                            <label class="btn btn-secondary" onclick="toggleActive(this);"><input type="radio" name="options"  class="radio-sign" value="9">Sagittarius</label>
                            <label class="btn btn-secondary" onclick="toggleActive(this);"><input type="radio" name="options"  class="radio-sign" value="10">Capricorn</label>
                            <label class="btn btn-secondary" onclick="toggleActive(this);"><input type="radio" name="options"  class="radio-sign" value="11">Aquarius</label>
                            <label class="btn btn-secondary" onclick="toggleActive(this);"><input type="radio" name="options"  class="radio-sign" value="12">Pisces</label>
                        </div>
                        </p>
                </div>
            </div>
                        </form>
            </div>

                </div>
                <div class="col-md-7">

                    <!-- Output part -->
                    <div class="astrological-output">
                    <div id="template-counter-sun-label" class="template">
                        At <strong class='body-distance'>40</strong>m away, the Golden Gate Bridge has the same gravitational pull as the Sun.
                        <br>
                        When placed at <strong class='body-angle'></strong>&deg; clockwise from North, the bridge will cancel out the Sun sign <strong class='body-sign'></strong>.
                    </div>
                    <div id="template-mass-sun-label" class="template">
                        The Sun, our nearest star, weighs <strong class='body-mass'>330,000</strong> Earths and is <strong id='body-distance'>150 million</strong> km away, at <strong class='body-angle'></strong>&deg;.
                    </div>
                    <div id="template-simulated-sun-label" class="template">
                        At <strong class='body-distance'>40</strong>m away, and <strong class='body-angle'></strong>&deg; clockwise from North, the Golden Gate Bridge will act like the Sun in <strong class='body-sign'></strong>.
                    </div>
                    <div id="template-no-change-label" class="template">
                        You're already a <strong class='body-sign'></strong>, you don't need to change anything.
                    </div>
                        <!-- SETH: I copied everything below from the codepen of the clock at https://codepen.io/mohebifar/pen/KwdeMz .  We will use it as the basis of our illustration because it has the basic rudiments of our endgoal.  You will see that, just like the <head> section uses tag language to define the site's metadata, and the <body> section uses tag language to define its content, the <svg> section uses tag language to define exactly the type of "SVG" graphics that you use to build powerpoint slides. That makes it easy to plug programmable vector graphics into a webpage.  That will be the centerpiece of our site.-->

                        <svg width="600" height="600" class="illustration">

                            <filter id="innerShadow" x="-20%" y="-20%" width="140%" height="140%">
                            <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur"/>
                            <feOffset in="blur" dx="2.5" dy="2.5"/>
                            </filter>

                            <g>
                            <circle id="circle" style="stroke: #FFF; stroke-width: 12px; fill:#20B7AF" cx="300" cy="300" r="160"></circle>
                            </g>
                            <g>
                            


                        
                            </line>
                            <!--SETH: To get the moon in place of the second hand, I commented out the <line> below and replaced it with the <image> command, which lets you embed an SVG (or other type of image) within an SVG image.  I pulled the image from flaticon.com By keeping the id="secondhand", I ensured that the javascript at the bottom of the page, in the <script> tags, would speak to this image rather than to the line that used to function as the second hand.  -->
                            <!-- <line x1="300" y1="300" x2="300" y2="120" style="stroke-width: 2px; stroke: #C1EFED;" id="secondhand"> -->
                           
    </image>
    </g>
    <g class="astro-supporting-elements">
                            <image x="500" y="100" width="120" height="120" xlink:href="96640_simple.svg"  id="secondhand" >
    </g>
    <g class="sun-pair">
        <image x="50" y="50" width="150" height="150" xlink:href="787892.svg"  id="mass-sun" class="svg-obj-planetary invisible tooltipped" title="" data-tippy />
        <image x="0" y="0" width="150" height="150" xlink:href="188820.svg"  id="counter-sun" class="svg-obj-surrogate tooltipped invisible" onmouseover="inquireSurrogate(this, 'in');" onmouseout="inquireSurrogate(this, 'out');" title="" />
    </g>
    <g class="new-sun-pair">
        <image x="50" y="50" width="150" height="150" xlink:href="787892.svg"  id="desired-sun" class="svg-obj-planetary invisible tooltipped" title="" data-tippy />
        <image x="0" y="0" width="150" height="150" xlink:href="188820.svg"  id="simulated-sun" class="svg-obj-surrogate tooltipped invisible" onmouseover="inquireSurrogate(this, 'in');" onmouseout="inquireSurrogate(this, 'out');" title="" />
    </g>
    <circle style="fill:#128A86; stroke: #C1EFED; stroke-width: 2px;" cx="300" cy="300" r="6">  </circle>
<!--SETH: I got the baby in the middle by plugging it in with an image tag below. I wasn't sure where to put it, so I tried putting it in lots of places in the SVG until I got it right.  But an educated guess said to put it near the main middle circle, so I mainly just had to find that.  Is there something about the circle above that gives us a hint its the right one?-->
    <image id="center" class="tooltipped" x="200" y="200" width="200" height="200" xlink:href="baby_surprised_birth4.svg"  />

    </svg>

    </div>
    </div>
    </div>
    </div>

<footer class="page-footer font-small blue pt-4" height=100>
    </footer>

    <!-- jquery -->
    <!--<script src="vendor/jquery/jquery.min.js"></script>-->
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <!-- Bootstrap core JavaScript -->
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!--other helpers-->
    <!--Tippy-->
    <script src="https://unpkg.com/tippy.js@2.5.4/dist/tippy.all.min.js"></script>
    <!--zodiac sign helper function getZodiacSign(day, month) from https://gist.github.com/kladov/5080233 -->

    <!--locaiton picker, using google maps-->
    <script  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlMsmI2dmRYtPujcwocMoF2yQxo7Qkmpk" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="vendor/latlonpicker/css/jquery-gmaps-latlon-picker.css"/>
    <script>
        $.gMapsLatLonPickerNoAutoInit = 1;
    </script>
    <script src="vendor/latlonpicker/js/jquery-gmaps-latlon-picker.js"></script>
    <script src="vendor/tz-lookup/tz.js"></script>
    <script src="vendor/moment/min/moment.min.js"></script>
    <script src="vendor/moment-timezone/builds/moment-timezone-with-data.min.js"></script>
        <script>

//&callback=initMap
function initMap() {
};
    /*
    map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 23, lng: -46},
    zoom: 18,
    mapTypeId: 'satellite',
    heading: 90,
    tilt: 45
  });
    */
    $(".gllpLatlonPicker").each(function() {
      $obj = $(document).gMapsLatLonPicker();

      //$obj.params.strings.markerText = "Double-click on location or drag marker";
      $obj.params.mapOptions.fullscreenControl = false;
      $obj.params.mapOptions.zoomControl = false;
  //    $obj.params.mapOptions.mapTypeId = 'satellite';
      $obj.params.mapOptions.zoom = 5;


      $obj.params.displayError = function(message) {
        console.log("MAPS ERROR: " + message); // instead of alert()
      };

      $obj.init( $(this) );
        console.log($obj);
        $obj.vars.map.center = new google.maps.LatLng(23 , -46);
      
      /**
         * The CenterControl adds a control to the map that recenters the map on
         * Chicago.
             * This constructor takes the control DIV as an argument.
             * @constructor
         */
            function CenterControl(controlDiv, map) {

                  // Set CSS for the control border.
                  var controlUI = document.createElement('div');
                  controlUI.style.backgroundColor = '#fff';
                  controlUI.style.border = '2px solid #fff';
                  controlUI.style.borderRadius = '3px';
                  controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
                  controlUI.style.cursor = 'pointer';
                  controlUI.style.marginBottom = '22px';
                  controlUI.style.textAlign = 'center';
                  controlUI.title = 'Click to recenter the map';
                  //controlDiv.appendChild(controlUI);

                  // Set CSS for the control interior.
                  var controlText = document.createElement('div');
                  controlText.style.color = 'rgb(25,25,25)';
                  controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
                  controlText.style.fontSize = '11px';
                  controlText.style.lineHeight = '38px';
                  controlText.style.paddingLeft = '5px';
                  controlText.style.paddingRight = '5px';
                  controlText.style.paddingTop = '0px';
                  controlText.innerHTML = 'Double-click on your location or drag marker';
                  //controlUI.appendChild(controlText);

                  controlDiv.appendChild(controlText);

            }


        
  // Create the DIV to hold the control and call the CenterControl()
  // constructor passing in this DIV.
  var centerControlDiv = document.createElement('div');
  var centerControl = new CenterControl(centerControlDiv, map);

  centerControlDiv.index = 1;
  $obj.vars.map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv);
});
        </script>



                        </body>

                        <!-- SETH: I copied the javascript below from the codepen.  you can embed javascript into HTML with <script> tags. This makes your html file into something that literally edits itself on the fly. That's how the clock keeps moving. The code above for the hands above says they should be roughly at the 4 o'clock position, the default that you'll see if you break the script below.  The script below rewrite the numbers specificy that default to be whatever the time is. -->
<script>

/** * * * * * * * * * * **\
 **
 ** CHANGE basic functionality
 **
\** * * * * * * * * * * **/

// fix modulo: https://stackoverflow.com/questions/4467539/javascript-modulo-gives-a-negative-result-for-negative-numbers
Number.prototype.mod = function(n) {
    return ((this%n)+n)%n;
};





/** * * * * * * * * * * **\
 **
 ** DEFINE helpers
 **
\** * * * * * * * * * * **/


/** * * * * * * * * * * **\
 ** DEFINE helpers: generic
\** * * * * * * * * * * **/

/**
* from https://gist.github.com/Xeoncross/7663273
 * IE 5.5+, Firefox, Opera, Chrome, Safari XHR object
 *
 * @param string url
 * @param object callback
 * @param mixed data
 * @param null x
 */
function ajax(url, callback, data, x) {
    try {
        x = new(this.XMLHttpRequest || ActiveXObject)('MSXML2.XMLHTTP.3.0');
        x.open(data ? 'POST' : 'GET', url, 1);
        x.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        x.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        x.onreadystatechange = function () {
            x.readyState > 3 && callback && callback(x.responseText, x);
        };
        x.send(data)
    } catch (e) {
        window.console && console.log(e);
    }
};

// https://plainjs.com/javascript/manipulation/wrap-an-html-structure-around-an-element-28/
function wrap(el, wrapper) {
        el.parentNode.insertBefore(wrapper, el);
            wrapper.appendChild(el);
}



/** * * * * * * * * * * **\
 ** DEFINE helpers: astrological
\** * * * * * * * * * * **/

/**
 * Return zodiac sugn by month and day
 *
     * @param day
 * @param month
 * @return {string} name of zodiac sign
 */
var zodiacSigns = {
    'capricorn':10,
    'aquarius':11,
    'pisces':12,
    'aries': 1,
    'taurus': 2,
    'gemini': 3,
    'cancer': 4,
    'leo':5,
    'virgo':6,
    'libra':7,
    'scorpio':8,
    'sagittarius':9,
}
var zodiacSignsInv = {
    10: 'Capricorn',
    11: 'Aquarius',
    12: 'Pisces',
    1:  'Aries',
    2:  'Taurus',
    3:  'Gemini',
    4:  'Cancer',
    5:  'Leo',
    6:  'Virgo',
    7:  'Libra',
    8:  'Scorpio',
    9: 'Sagittarius',
}

function getZodiacSign(day, month) {

    if((month == 1 && day <= 20) || (month == 12 && day >=22)) {
        return zodiacSigns.capricorn;
    } else if ((month == 1 && day >= 21) || (month == 2 && day <= 18)) {
        return zodiacSigns.aquarius;
    } else if((month == 2 && day >= 19) || (month == 3 && day <= 20)) {
        return zodiacSigns.pisces;
    } else if((month == 3 && day >= 21) || (month == 4 && day <= 20)) {
        return zodiacSigns.aries;
    } else if((month == 4 && day >= 21) || (month == 5 && day <= 20)) {
        return zodiacSigns.taurus;
    } else if((month == 5 && day >= 21) || (month == 6 && day <= 21)) {
        return zodiacSigns.gemini;
    } else if((month == 6 && day >= 22) || (month == 7 && day <= 22)) {
        return zodiacSigns.cancer;
    } else if((month == 7 && day >= 23) || (month == 8 && day <= 23)) {
        return zodiacSigns.leo;
    } else if((month == 8 && day >= 24) || (month == 9 && day <= 23)) {
        return zodiacSigns.virgo;
    } else if((month == 9 && day >= 24) || (month == 10 && day <= 23)) {
        return zodiacSigns.libra;
    } else if((month == 10 && day >= 24) || (month == 11 && day <= 22)) {
        return zodiacSigns.scorpio;
    } else if((month == 11 && day >= 23) || (month == 12 && day <= 21)) {
        return zodiacSigns.sagittarius;
    }
}





/** * * * * * * * * * * **\
 **
 ** SETUP page
 **
\** * * * * * * * * * * **/


/** * * * * * * * * * * **\
 ** SETUP page: vestiges
\** * * * * * * * * * * **/



var cx = 300;
var cy = 300;
var radius = 200;

function shifter(val) {
    return [val, cx, cy].join(' ');
}

var date = new Date();
var hoursAngle = 360 * date.getHours() / 12 + date.getMinutes() / 2;
var minuteAngle = 360 * date.getMinutes() / 60;
var secAngle = 360 * date.getSeconds() / 60;



for(var i = 1; i <= 12; i++) {
    var el = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    el.setAttribute('x1', '300');
    el.setAttribute('y1', '160');
    el.setAttribute('x2', '300');
    el.setAttribute('y2', '150');
    el.setAttribute('transform', 'rotate(' + (i*360/12) + ' 300 300)');
    el.setAttribute('style', 'stroke: #ffffff;');
    document.querySelector('svg').appendChild(el);
}



/** * * * * * * * * * * **\
 ** SETUP page: key elements
\** * * * * * * * * * * **/

///interactive elements of SVG

//Link counterbalanced entities
// a la https://codepen.io/anon/pen/BOowqg https://github.com/atomiks/tippyjs/issues/283
tippy('.tooltipped');

var elCounterSun = document.querySelector("#counter-sun");
var elSun = document.querySelector("#mass-sun");
var elSimulatedSun = document.querySelector("#simulated-sun");
var elDesiredSun = document.querySelector("#desired-sun");
var elCounterSunLabel = document.querySelector("#template-counter-sun-label");
var elSunLabel = document.querySelector("#template-mass-sun-label");
var elSimulatedSunLabel = document.querySelector("#template-simulated-sun-label");

// supporting elements
var elCenter = document.querySelector("svg.illustration #center");
var elNoChangeLabel = document.querySelector("#template-no-change-label");

var sunCurrentSVG = [];
sunCurrentSVG.push(elCounterSun); //0
sunCurrentSVG.push(elSun); //1
sunCurrentSVG.push(elCounterSunLabel); //2
sunCurrentSVG.push(elSunLabel); //3
var sunDesiredSVG = [];
sunDesiredSVG.push(elSimulatedSun); //0
sunDesiredSVG.push(elDesiredSun); //1
sunDesiredSVG.push(elSimulatedSunLabel); //2



/** * * * * * * * * * * **\
 ** SETUP page: tooltips and interface
\** * * * * * * * * * * **/

var tippyCountermass = tippy.one( elCounterSun , {
    html: elCounterSunLabel,
    delay: 0,
    duration: 0,
    placement: 'top',
    theme: 'hbwys',
});
var tippyPlanet = tippy.one( elSun, {
    trigger : 'manual',
    html: elSunLabel,
    delay: 0,
    duration: 0,
    placement: 'top',
    theme: 'hbwys',
} );
var tippySimulatedMass = tippy.one( elSimulatedSun , {
    html: elSimulatedSunLabel,
    delay: 0,
    duration: 0,
    placement: 'top',
    theme: 'hbwys',
});
var tippyNoChange = tippy.one( elCenter, {
    trigger : 'manual',
    html:  elNoChangeLabel,
    delay: 0,
    duration: 0,
    hideOnClick: false,
    placement: 'top',
    theme: 'hbwys',
});

// default trigger === 'mouseenter focus'
const showEvents = ['mouseenter', 'focus'];
const hideEvents = ['mouseleave', 'blur'];
showEvents.forEach(e => {
        elCounterSun.addEventListener(e, () => {
                tippyPlanet.show();
            });
});
hideEvents.forEach(e => {
        elCounterSun.addEventListener(e, () => {
                tippyPlanet.hide();
            });
});




/** * * * * * * * * * * **\
 ** SETUP page: helpers
\** * * * * * * * * * * **/

function populateFormWithDefaults(form) {
    /* 
        form.querySelector("#locationLat").defaultValue = "38.54";
        form.querySelector("#locationLon").defaultValue = "-121.74";
        // browser doesn't like this code: makes browser raise its security hackles.
        // https://developer.mozilla.org/en-US/docs/Web/API/Coordinates/longitude
        navigator.geolocation.getCurrentPosition(function(position) {
        let lat = position.coords.latitude;
        let long = position.coords.longitude;

        form.querySelector("#locationLat").innerText = lat.toFixed(2);
        form.querySelector("#locationLon").innerText = long.toFixed(2);
    });
    */
    var date = new Date();
    form.querySelector("#date").defaultValue = $.datepicker.formatDate("yy-mm-dd", date);
    form.querySelector("#time").defaultValue = date.getHours().toString().padStart(2,0) + ":" + date.getMinutes().toString().padStart(2,0);

}





/** * * * * * * * * * * **\
 **
 ** MAIN function
 **
\** * * * * * * * * * * **/

var sAstroShell;
function fetchSwissAstroSun( el ) {
    var slat, slon, sdate, stime, omoment, stimeutc, currentSunSign, inDesiredSunSign;
    //console.log( el );
    // extract form's input variables
    var inCoord = el.querySelector("#locationCoordinates").value.split(', ');
    slat = inCoord[0];
    slon = inCoord[1];
    sdate = el.querySelector("#date").value;
    stime = el.querySelector("#time").value;
    omoment = moment(sdate+stime, moment.HTML5_FMT.DATE+moment.HTML5_FMT.TIME).format()
    omoment = moment.tz(omoment, tzlookup(slat, slon));
    stimeutc = omoment.utc().format('HH:mm:00');
    inDesiredSunSign = el.querySelector("#desiredsign > .active > input").value;
    sdate = omoment.format('D.M.YYYY');

        //https://devhints.io/moment
    console.log(omoment.format(), omoment.utc().format(), omoment.format('D.M.YYYY'), omoment.utc().format('HH:mm:00'));

    var iday = +omoment.format('D');
    var imonth = +omoment.format('M');
    var iyear = +omoment.format('YYYY');
    var currentSunSign = getZodiacSign(iday, imonth);
    var signDiff = (inDesiredSunSign - +currentSunSign ).mod( 12 );

    // assemble and submit request to cancel current sign, and define code that handles response text.
    var astroUrlUndoSun = "https://enfascination.com/swissephemeris/swetest.php?" +
        "b="+ encodeURIComponent(sdate) +
        "&p=0" + "&emos" + "&f=PjLBRsGg" +
        "&house=" + encodeURIComponent(slon) + "%2C" +
        encodeURIComponent(slat) + "%2CN" +
        "&ut=" + encodeURIComponent(stimeutc) + "%3A00";

    if (signDiff == 0) {
        // if they do pick their current sign, nothing should happen
        // visible illustrations shold be decativated
        activateIllustration( sunCurrentSVG[0], deactivate=true);
        activateIllustration( sunDesiredSVG[0], deactivate=true);
        // label prep: interpolate sign and manually show
        prepareLabels(  elNoChangeLabel, null, currentSunSign);
        tippyNoChange.show();

    // still some cases to consider: did user click "no sign" (one object) or some sign besides their current sign (2 objects)
    } else if (inDesiredSunSign !== "null") {
        //  clean up after one of the other conditions
        tippyNoChange.hide();

        // cancel out current sign
        console.log("call to", astroUrlUndoSun);
        //ajax("https://cors-anywhere.herokuapp.com/"+astroUrlUndoSun
        ajax(astroUrlUndoSun, function(dat) {
            postSubmit(dat , sunCurrentSVG)
        }, null, null);

        // prep to simulate other sign
        //console.log("got in here", inDesiredSunSign );
        var desiredMoment = omoment.add((30*signDiff), 'days');
        var sDesiredMoment = desiredMoment.format('D.M.YYYY');
        //console.log(slat, slon, omoment, stime, inDesiredSunSign);
        //console.log(inDesiredSunSign, omoment, "ASDF",desiredMoment, "ASDF", sDesiredMoment, signDiff);

        // assemble and submit request to simulate other sign, and define code that handles response text.
        var astroUrlNewSun = "https://enfascination.com/swissephemeris/swetest.php?" +
            "b="+ encodeURIComponent(sDesiredMoment) +
            "&p=0" + "&emos" + "&f=PjLBRsGg" +
            "&house=" + encodeURIComponent(slon) + "%2C" +
            encodeURIComponent(slat) + "%2CN" +
            "&ut=" + encodeURIComponent(stimeutc) + "%3A00";
        console.log("call to", astroUrlNewSun);
        ajax(astroUrlNewSun, function(dat) {
                postSubmit(dat , sunDesiredSVG, mode="simulate")
                }, null, null);
    } else {
        // if they do pick "no sign", be sure to disappear the other objects

        //  clean up after one of the other conditions
        tippyNoChange.hide();


        // first cancel out current sign
        console.log("call to", astroUrlUndoSun);
        //ajax("https://cors-anywhere.herokuapp.com/"+astroUrlUndoSun
            ajax(astroUrlUndoSun, function(dat) {
                postSubmit(dat , sunCurrentSVG)
            }, null, null);

        // disappear the other objects
        activateIllustration( sunDesiredSVG[0], deactivate=true);
    }

    // DISABLE current sign as an option
    //   SUPE BUGGY (event handling and disabling are interfereing with tippy
    /*
    var formSignOption = el.querySelector(`#desiredsign input[value='${currentSunSign}']`); //get option
    var formSignOptionLabel = formSignOption.parentElement;
    formSignOption.classList.add('disabled'); //disabled the input tag
    // TELL tippy about disabling (keeping in mind tha tdisabled elements don't fire events)
    formSignOptionLabel.setAttribute('title', 'This is your current sign, so if you want it, you don\'t have to do anything.');
    formSignOptionLabel.classList.add("tooltipped");
    // TELL boostrap about disabling disabled
    //   parent is the label tag which has most of the styling
    formSignOptionLabel.classList.add('disabled');
    //formSignOptionLabel.removeAttribute("onclick"); //trying to get tooltip back
    */

}



/** * * * * * * * * * * **\
 **
 ** MAIN function: helpers
 **
\** * * * * * * * * * * **/


/**
    this runs after we get the data from the other site, which should trigger lots of action.
    pull the astro printout from the return value
it comes out as a string, which we convert to a DOM object for easy searching
*/
function postSubmit(sAstroShell, elsvg, mode="counter") {
    // parse raw input
    //    (custonmize edepending on control over backend)
    //    DON't need for current backend
    // sAstroShell = parseAstroResponse( sAstroShell );

    // extract angles from parsed response
    var angles = getAngles(sAstroShell);
    var sunAngle = angles['sunAngle'];
    var ascendant = angles['ascendant'];
    var meridian = angles['meridian'];
    var sunSign = angles['sunSign'];

    //console.log("postSubmit", angles);

    // Position object into SVG using output
    //  compute angle to send to image
    var astroAngle = imageAngleFromAstroAngle(ascendant, meridian, sunAngle);
    // edit HTML
    positionObjectPairInSVG(elsvg[0], elsvg[1], radius, astroAngle, mode=mode);

    // PREPARE labels (tooltips) for each obejct (dynamic content)
    if (mode == "counter") {
        prepareLabels(elsvg[2], (astroAngle - Math.PI), sunSign);
        prepareLabels(elsvg[3], astroAngle);
    } else if (mode == "simulate") {
        prepareLabels(elsvg[2], astroAngle, sunSign);
    }

    activateIllustration(elsvg[0]);

};
function parseAstroResponse( sAstroShell ) {
    // vestigates fromwhen I was scraping from http://www.astro.com/swisseph/swetest.htm
    // useful for making html in strings easily manipulable
    var parser = new DOMParser()
    var htmlAstro = parser.parseFromString(sAstroData, "text/html");
    console.log(htmlAstro);
    sAstroShell = htmlAstro.querySelector("pre > font").innerText;
    console.log( sAstroShell);
    return sAstroShell
}

function getAngles(sAstroShell) {
    var sunAngle, sunSign, meridian, ascendant;
    // now use regexes to search the printout for the right digits.
    //  according to the math team, we need angles for the sun, AC and MC.
    sunAngle = sAstroShell.match(
        /\bSun\s+([0-9\.]+)\s+(\d{1,3})Â°\s?(\d\d?)'\s?(\d\d?).(\d{4})\s+/
    );
    sunSign = Math.floor(+(sunAngle[1]));
    sunAngle = sunAngle[2];
    ascendant = sAstroShell.match(/\bAscendant\s+(\d{1,3})Â°\s?(\d\d?)'\s?(\d\d?).(\d{4})\s+/)[1];
    meridian = sAstroShell.match(/\bMC\s+(\d{1,3})Â°\s?(\d\d?)'\s?(\d\d?).(\d{4})\s+/)[1];
    // convert to radians
    sunAngle = (sunAngle / 360) * 2 * Math.PI;
    ascendant = (ascendant / 360) * 2 * Math.PI;
    meridian = (meridian / 360) * 2 * Math.PI;
    var angles = {
        "sunAngle" : sunAngle,
        "ascendant" : ascendant,
        "meridian" : meridian,
        "sunSign" : sunSign,
    }
    return(angles);
};

function imageAngleFromAstroAngle(ascendant, meridian, sunAngle) {
    // use sun angle, AC and MC to calculate position of object relative to baby
    //minuteAngle = sunAngle;
    minuteAngle = 360 * sunAngle / 60;
    var secAngle = 360 * date.getSeconds() / 60; //really just here for testing
    var astroAngle = -( //negate because mirror image from looking down instead of up
        //Math.PI //to counterbalance mass
        0 // to show the planetary body, not its opposite
        - (2*Math.PI - ascendant) //to get the ascendant zeroed to the east (substracting distance from spring equinox)
        - meridian // to add the effect of being at noon
        + (meridian - sunAngle) //to get actual hour of day
    ) % (2*Math.PI);
    var astroAngle2 = -( //negate because mirror image from looking down instead of up
        //Math.PI //to counterbalance mass
        0 // to show the planetary body, not its opposite
        + (ascendant - sunAngle) //to get angle from east facing
    ) % (2*Math.PI);
    astroAngle = astroAngle.mod( 2*Math.PI );
    astroAngle2 = astroAngle2.mod( 2*Math.PI );
    console.log((astroAngle/(Math.PI*2)*360), (astroAngle2/(Math.PI*2)*360) );
    return(astroAngle);
}

function positionObjectPairInSVG(counterMass, mass, radius, astroAngle, mode="counter") {
    var angleOffset = (mode == "counter") ? Math.PI : 0; // are we cancelling out or simulating a heavenly body?
    mass.setAttribute('x',cx - 75 + radius*Math.cos(astroAngle));  // the 75 is half the width/height of the bridge image, because its 0 point is in its upper left corner, not in its center.
    mass.setAttribute('y',cy - 75 + radius*Math.sin(astroAngle));
    counterMass.setAttribute('x',cx - 75 + radius*Math.cos(astroAngle + angleOffset));  // the 75 is half the width/height of the bridge image, because its 0 point is in its upper left corner, not in its center.
    counterMass.setAttribute('y',cy - 75 + radius*Math.sin(astroAngle + angleOffset));
}

function activateIllustration(el, deactivate=false){
    // activate illustration
    // (make it visible)
    //console.log( el );
    if (!deactivate) {
        el.classList.remove("invisible");
        el.classList.add("visible");
    } else {
        el.classList.remove("visible");
        el.classList.add("invisible");
    }
}

function prepareLabels(labelTemplate, astroAngle, sSign ) {
    // (popoulate labels with caluclated content)
    var sAstroAngle = ((astroAngle + Math.PI/2) / (2*Math.PI) * 360).mod( 360 ).toFixed(0);
    var templateAngle = labelTemplate.querySelector(".body-angle");
    var templateSign = labelTemplate.querySelector(".body-sign");
    if (templateAngle !== null) {
        templateAngle.innerText = sAstroAngle;
    }
    if (templateSign !== null) {
        templateSign.innerText = zodiacSignsInv[sSign];
    }
    console.log(templateAngle);
};

function inquireSurrogate(el, direction) {
    if (true) {
        if (direction == "in") {
            el.parentElement.querySelector(".svg-obj-planetary").classList.remove("invisible");
            el.parentElement.querySelector(".svg-obj-planetary").classList.add("visible");
        } else if (direction == "out") {
            el.parentElement.querySelector(".svg-obj-planetary").classList.add("invisible");
            el.parentElement.querySelector(".svg-obj-planetary").classList.remove("visible");
        }
    }
}

function toggleActive(el){
    if (el.classList.contains("active")) {
    } else {
        el.parentElement.querySelector(".active").classList.remove("active");
        el.classList.add("active");
    }
}




/** * * * * * * * * * * **\
 **
 ** FINAL setup
 **
\** * * * * * * * * * * **/


var mainForm = document.getElementById('astro-main-form');
populateFormWithDefaults(mainForm);

// run this with default values on page load.  Then again on form submit
fetchSwissAstroSun( mainForm );



</script>

</html>
